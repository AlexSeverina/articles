\section{Через тензорное произведение}

\subsection{Рекурсивные автоматы}

Определение, примеры.

\begin{figure}[h]
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state, initial] (q_0)   {$0 \{S\}$}; 
   \node[state] (q_1) [right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_1] {$2$}; 
   \node[state, accepting] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {S} (q_2)
    (q_2) edge  node {b} (q_3)
    (q_1) edge[bend left, above]  node {b} (q_3);
\end{tikzpicture}
\end{center}

\caption{Рекурсивный автомат для грамматики!!!}
\label{input}
\end{figure}


\subsection{Тензорное произведение}

Оно же произведение Кронекера (для матриц).

Матриц и графов

Сперва дадим классическое определение тензорного произведения двух неориентированных графов.
\begin{definition}
Пусть даны два графа: $\mathcal{G}_1 = \langle V_1, E_1\rangle$ и $\mathcal{G}_2 = \langle V_2, E_2\rangle$. 
Тензорным произведением этих графов будем называть граф $\mathcal{G}_3 = \langle V_3, E_3\rangle$, где $V_3 = V_1 \times V_2$, $E_3 = \{ ((v_1,v_2),(u_1,u_2)) \mid (v_1,u_1) \in E_1 \text{ и } (v_2,u_2) \in E_2 \}$.
\end{definition}

Иными словами, тензорным произведением двух графов является граф, такой что:
\begin{enumerate}
 \item множество вершин --- это прямое произведение множемтв вершин исходных графов;
 \item ребро между вершинами $v=(v_1,v_2)$ и $u=(u_1,u_2)$ существует тогда и только тогда, когда существуют рёбра между парами вершин $v_1$, $u_1$ и $v_2$, $u_2$ в соответсвующих графах. 
\end{enumerate}

Для того, чтобы построить тензорное произведение ориентированных графов, необходимо в предыдущем определении, в условии существования реба в результирующем графе, дополнительно потребовать, чтобы направления рёбер совпадали.
Данное требование получается естесвенным образом, если считать, что пары вершин, задающие ребро упорядочены, поэтому формальное определение отличаться не будет.

Нетрудно заметить, что матрица смежности графа $\mathcal{G}_3$ равна тенорному произведению матриц смежностей исходных графов.

Осталось добавить метки к рёбрам.
Это приведёт к логичному усилению требованя к существованию ребра: метки рёбер в исходных графах должны совпадать.
Таким образом, мы получаем следующее определение тензорного произведения ориентированных графов с метками на рёбрах.
\begin{definition}

Пусть даны два ориентированных графа с метками на рёбрах: $\mathcal{G}_1 = \langle V_1, E_1, L_1 \rangle$ и $\mathcal{G}_2 = \langle V_2, E_2, L_2 \rangle$.
Тензорным произведением этих графов будем называть граф $\mathcal{G}_3 = \langle V_3, E_3, L_3\rangle$, где $V_3 = V_1 \times V_2$, $E_3 = \{ ((v_1,v_2),l,(u_1,u_2)) \mid (v_1,l,u_1) \in E_1 \text{ и } (v_2,l,u_2) \in E_2 \}$, $L_3=L_1 \cap L_2$.

\end{definition}


Рассмотрим пример.
В качестве одного из графов возьмём рекурсивный автомат, построенный ранее!!!.
Его матрица смежности выглядит следующим образом.
$$ M_1 =
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
$$


\begin{figure}[h]
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a} (q_2)
    (q_2) edge  node {a} (q_0)
    (q_2) edge[bend left, above]  node {b} (q_3)
    (q_3) edge[bend left, below]  node {b} (q_2);
\end{tikzpicture}
\end{center}

\caption{The input graph}
\label{input}
\end{figure}


Второй граф представлен на изображении~\ref{input}.
Его матрица смежности имеет следующий вид.
$$ M_2 =
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [a] & . \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
$$



Вычислим $M_1 \otimes M_2$.

\begin{align}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [a] & . \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  .   & [a] & .   & .  &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  .   & .   & [a] & .  &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  [a] & .   & .   & .  &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  .   & .   & .   & .  &  . & . & . & .  &  . & . & . & .   \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & . 
\end{array}\right)
\label{eq:graph_tm}
\end{align}



\subsection{Алгоритм}

Идея алгоритма основана на обобщении пересечения двух конечных автоматов до пересечения рекурсивной сети, построенной по грамматике, со входным графом.

Несколько наблюдений
Путь из нетерминалов и терминалов.
При этом должны быть пути из терминалов. Иначе не задать язык.
Будем насыщать граф рёбрами, помеченными нетерминалами.

По грамматике строим автомат.
r~\ref{eq:graph_tm}

В цикле: пересекли через тензорное произведение, замкнули через обычное матричное произведение, чтобы найти пути из начальной в конечную в граммтике, поставили в соответствующие ячейки нетерминалы, добавили соответствующие рёбра в исходный граф.


Можно вычислять только разницу.
Для этого, правда, потребуется держать ещё одну матрицу.
И надо проверять, что вычислительно дешевле: поддерживать разницу и потом каждый раз поэлементно складывать две матрицы или каждый раз вычислять полностью произведение.

Всего несколько матриц.
Разреженные.
Необходимо отметить, что для реальных графов и запросов результат тензорного произведения будет очень разрежен.
На готовых либах должно быть быстро.

\subsection{Примеры}

Рассмотрим ряд примеров работы описанного алгоритма.
Разница выделена жирным.

\textbf{Пример 1.}


Худший случай.
Такой же как и для матричного.

\begin{align}
%\begin{split}
tc(M_3) =
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .  &  . & . & . & .\\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .  &  . & . & . & \textbf{[ab]}   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & . 
\end{array}\right)
%\end{split}
\label{eq:graph_tm}
\end{align}

Мы видим, что в результате транзитивного замыкания появилось новое ребро с меткой $ab$ из вершины $(0,1)$ в вершину $(3,3)$.
Так как вершина 0 является стартовой в рекурсивном автоматие, а 3 является финальной, то слово вдоль пути из вершины 1 в вершину 3 во входном графе выводимо из нетерминала $S$.
Это означает, что в графе должно быть добавлено ребро из $0$ в $3$ с меткой $S$, после чего граф будет выглядеть следующим образом:

\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a} (q_2)
    (q_2) edge  node {a} (q_0)
    (q_1) edge[bend left, above]  node {\textbf{S}} (q_3)
    (q_2) edge[bend left, above]  node {b} (q_3)
    (q_3) edge[bend left, below]  node {b} (q_2);
\end{tikzpicture}
\end{center}

Матрица смежности обновлённого графа:

$$ M_2 =
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [a] & \textbf{[S]} \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
$$

Итерация закончена. 
Возвращаемся к началу цикла и вновь вычисляем тензорное произведение.

\textbf{Итерация 3.}

\begin{align}
%\begin{split}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [a] & [S] \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\begin{pmatrix} 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & [S]  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & . 
\end{pmatrix}
%\end{split}
\label{eq:graph_tm}
\end{align}

Транзитивное замыкание:

\begin{align}
%\begin{split}
tc(M_3) =
\begin{pmatrix} 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & \textbf{[aS]}  &  . & . & \textbf{[aSb]} & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .              &  . & . & .              & [ab]   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .              &  . & . & .              & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & .              & .   \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & [S]            &  . & . & \textbf{[Sb]}    & .    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & .    & [b]  \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b]  & .    \\
%                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b] & . \\
%                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & . 
\end{pmatrix}
%\end{split}
\label{eq:graph_tm}
\end{align}

Обновлённый граф:
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a} (q_2)
    (q_2) edge  node {a} (q_0)
    (q_1) edge[bend left, above]  node {S} (q_3)
    (q_0) edge[bend right, below]  node {S} (q_2)
    (q_2) edge[bend left, above]  node {b} (q_3)
    (q_3) edge[bend left, below]  node {b} (q_2);
\end{tikzpicture}
\end{center}

И матрица смежности:

$$ M_2 =
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a] & [S] \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
$$


Следующая итерация основного цикла.

\begin{align}
%\begin{split}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a] & [S] \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\begin{pmatrix} 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
%
. & . & . & .  &  . & . & . & .    &  . & . & [S] & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & [S]  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .    &  . & . & [b] & . \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & . 
\end{pmatrix}
%\end{split}
\label{eq:graph_tm}
\end{align}

Транзитивное замыкание:

\begin{align}
%\begin{split}
tc(M_3) =
\begin{pmatrix} 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & [aS]           &  . & . & [aSb] & .     \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .              &  . & . & .     & [ab]  \\
. & . & . & .  &  [a] & . & . & .  &  . & . & \textbf{[aS]} & .  &  . & . & .     & [aSb] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & .     & .     \\
%
. & . & . & .  &  . & . & . & .    &  . & . & [S] & .            &  . & . & .    & \textbf{[Sb]}    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & [S]            &  . & . & [Sb] & .    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & .    & [b]  \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b]  & .    \\
%                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b] & . \\
%                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & . 
\end{pmatrix}
%\end{split}
\label{eq:graph_tm}
\end{align}

Обновлённый граф:
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a} (q_2)
    (q_2) edge  node {a} (q_0)
    (q_1) edge[bend left, above]  node {S} (q_3)
    (q_0) edge[bend right, below]  node {S} (q_2)
    (q_2) edge[bend left, above]  node {b,\textbf{S}} (q_3)
    (q_3) edge[bend left, below]  node {b} (q_2);
\end{tikzpicture}
\end{center}

И матрица смежности:

$$ M_2 =
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a] & [S] \\
[a] & . & . & [b, \textbf{S}] \\
. & . & [b] & . 
\end{pmatrix}
$$

Следующая итерация основного цикла.

\begin{align}
%\begin{split}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a] & [S] \\
[a] & . & . & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\begin{pmatrix} 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
%
. & . & . & .  &  . & . & . & .    &  . & . & [S] & .             &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & [S]           &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & \textbf{[S]}  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .             &  . & . & [b] & . \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & . 
\end{pmatrix}
%\end{split}
\label{eq:graph_tm}
\end{align}

Транзитивное замыкание:

\begin{align}
%\begin{split}
tc(M_3) =
\begin{pmatrix} 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & [aS]           &  . & . & [aSb]          & .     \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & \textbf{[aS]}  &  . & . & \textbf{[aSb]} & [ab]  \\
. & . & . & .  &  [a] & . & . & .  &  . & . & [aS] & .           &  . & . & .              & [aSb] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & .              & .     \\
%
. & . & . & .  &  . & . & . & .    &  . & . & [S] & .            &  . & . & .             & [Sb]    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & [S]            &  . & . & [Sb]          & .    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & [S]            &  . & . & \textbf{[Sb]} & [b]  \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b]           & .    \\
%                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b] & . \\
%                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & . 
\end{pmatrix}
%\end{split}
\label{eq:graph_tm}
\end{align}

Обновлённый граф:
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a,\textbf{S}} (q_2)
    (q_2) edge  node {a} (q_0)
    (q_1) edge[bend left, above]  node {S} (q_3)
    (q_0) edge[bend right, below]  node {S} (q_2)
    (q_2) edge[bend left, above]  node {b,S} (q_3)
    (q_3) edge[bend left, below]  node {b} (q_2);
\end{tikzpicture}
\end{center}

И матрица смежности:

$$ M_2 =
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a, \textbf{S}] & [S] \\
[a] & . & . & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
$$

Следующая итерация основного цикла.

\begin{align}
%\begin{split}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a,S] & [S] \\
[a] & . & . & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\begin{pmatrix} 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
%
. & . & . & .  &  . & . & . & .    &  . & . & [S]          & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & \textbf{[S]} & [S]  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .            & [S]  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & .            & .    &  . & . & [b] & . \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & . 
\end{pmatrix}
%\end{split}
\label{eq:graph_tm}
\end{align}

Транзитивное замыкание:

\begin{align}
%\begin{split}
tc(M_3) =
\begin{pmatrix} 
. & . & . & .  &  . & [a] & . & .  &  . & . & \textbf[aS] & [aS]  &  . & . & [aSb] & \textbf{[aSb]}  \\
. & . & . & .  &  . & . & [a] & .  &  . & . & .           & [aS]  &  . & . & [aSb] & [ab]          \\
. & . & . & .  &  [a] & . & . & .  &  . & . & [aS]        & .     &  . & . & .     & [aSb]         \\
. & . & . & .  &  . & . & . & .    &  . & . & .           & .     &  . & . & .     & .             \\
%
. & . & . & .  &  . & . & . & .    &  . & . & [S] & .             &  . & . & .    & [Sb]    \\
. & . & . & .  &  . & . & . & .    &  . & . & [S] & [S]           &  . & . & [Sb] & \textbf{[Sb]}    \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & [S]           &  . & . & [Sb] & [b]  \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .             &  . & . & [b]  & .    \\
%                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & [b]  & . \\
%                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & . 
\end{pmatrix}
%\end{split}
\label{eq:graph_tm}
\end{align}

Обновлённый граф:
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a,S} (q_2)
    (q_2) edge[bend right, above]  node {a} (q_0)
    (q_1) edge[bend left, above]  node {S} (q_3)
    (q_0) edge[bend right, above]  node {S} (q_2)
    (q_2) edge[bend left, above]  node {b,S} (q_3)
    (q_0) edge[bend right, below]  node {\textbf{S}} (q_3)
    (q_3) edge[bend left, above]  node {b} (q_2);
\end{tikzpicture}
\end{center}

И матрица смежности:

$$ M_2 =
\begin{pmatrix} 
. & [a] & [S] & \textbf{[S]} \\
. & . & [a, S] & [S] \\
[a] & . & . & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
$$


И наконец последняя содержательная итерация основного цикла.

\begin{align}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & [S] & [S] \\
. & . & [a,S] & [S] \\
[a] & . & . & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\begin{pmatrix} 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
%
. & . & . & .  &  . & . & . & .    &  . & . & [S] & \textbf{[S]}    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & [S] & [S]             &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & [S]             &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .               &  . & . & [b] & . \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
%
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & . 
\end{pmatrix}
\label{eq:graph_tm}
\end{align}

Транзитивное замыкание:

\begin{align}
%\begin{split}
tc(M_3) =
\begin{pmatrix} 
. & . & . & .  &  . & [a] & . & .  &  . & . & [aS] & [aS]           &  . & . & [aSb]          & [aSb]  \\
. & . & . & .  &  . & . & [a] & .  &  . & . & .    & [aS]           &  . & . & [aSb]          & [ab]          \\
. & . & . & .  &  [a] & . & . & .  &  . & . & [aS] & \textbf{[aS]}  &  . & . & \textbf{[aSb]} & [aSb]         \\
. & . & . & .  &  . & . & . & .    &  . & . & .    & .              &  . & . & .              & .             \\
%
. & . & . & .  &  . & . & . & .    &  . & . & [S] & \texttt{[S]}    &  . & . & \textbf{[Sb]}  & [Sb]    \\
. & . & . & .  &  . & . & . & .    &  . & . & [S] & [S]             &  . & . & [Sb] & [Sb]    \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & [S]             &  . & . & [Sb] & [b]  \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .               &  . & . & [b]  & .    \\
%                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & [b]  & . \\
%                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & . 
\end{pmatrix}
%\end{split}
\label{eq:graph_tm}
\end{align}

Обновлённый граф:
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a,S} (q_2)
    (q_2) edge[bend right, above]  node {a} (q_0)
    (q_2) edge[loop right]  node {\textbf{S}} (q_2)
    (q_1) edge[bend left, above]  node {S} (q_3)
    (q_0) edge[bend right, above]  node {S} (q_2)
    (q_2) edge[bend left, above]  node {b,S} (q_3)
    (q_0) edge[bend right, below]  node {S} (q_3)
    (q_3) edge[bend left, above]  node {b} (q_2);
\end{tikzpicture}
\end{center}

И матрица смежности:

$$ M_2 =
\begin{pmatrix} 
. & [a] & [S] & [S] \\
. & . & [a, S] & [S] \\
[a] & . & \textbf{[S]} & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
$$


Следующая итерация не приведёт к изменению графа.
Читатель может убедиться в этом самостоятельно.
Соответственно алгоритм можно завершать.

\textbf{Пример 2.}

В данном примере мы увидем, как структура грамматики и, соответственно, рекурсивной сети, влияет на процесс вычислений.

Интуитивно понятно, что чем меньше состояний в рекурсивной сети, тем лучше.
То есть желательно получить как можно более компактное описание контекстно-свободного языка.

Для примера возьмём в качестве КС языка язык Дика на двух типах скобок и опишем его двумя грамматиками.
Первая граммтика классическая:
$$
G_1 = \langle \{a,\ b\}, \{ S \}, \{S \to a \ S \ b \ S \mid \varepsilon  \} \rangle
$$

Во второй грамматике мы будем использовать конструкции регулярных выражений в правой части правил.
То есть вторая грамматика находитмся в EBNF~\cite{!!!}.
$$
G_2 = \langle \{a, \ b\}, \{S\}, \{S \to (a \ S \ b)^{*}\} \rangle
$$

Построим рекурсивные сети $N_1$ и $N_2$ для этих граммтик.


Рекурсивная сеть $N_1$:

\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state, initial, accepting] (q_0)   {$0$}; 
   \node[state] (q_1) [right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_1] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$}; 
   \node[state, accepting] (q_4) [right=of q_3] {$4$}; 
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {S} (q_2)
    (q_2) edge  node {b} (q_3)
    (q_3) edge  node {S} (q_4);
\end{tikzpicture}
\end{center}

Матрица смежности $N_1$:

$$
M_1^1 =
\begin{pmatrix}
. & [a] & .   & .   & .  \\
. & .   & [S] & .   & .  \\
. & .   & .   & [b] & .  \\
. & .   & .   & .   & [S] \\
. & .   & .   & .   & .
\end{pmatrix}
$$


Рекурсивная сеть $N_2$:

\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state, initial, accepting] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {S} (q_2)
    (q_2) edge  node {b} (q_0);
\end{tikzpicture}
\end{center}


Матрица смежности $N_2$:

$$
M_1^2 =
\begin{pmatrix}
.   & [a] & .    \\
.   & .   & [S]  \\
[b] & .   & . 
\end{pmatrix}
$$


Первое, очевидное, наблюдение --- количество состояний в $N_2$ меньше, чем в $N_1$.
Это значит, что матрицы будут меньше, считать быстрее.

Для того, чтобы проще было сделать второе, сперва выполним пошагово алгоритм для двух заданных рекурсивных сетей.


Вход возьмём линейный:
\begin{center}
\begin{tikzpicture}[node distance=2cm,shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_1] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$}; 
   \node[state] (q_4) [right=of q_3] {$4$}; 
   \node[state] (q_5) [right=of q_4] {$5$}; 
   \node[state] (q_6) [right=of q_5] {$6$}; 
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {b} (q_2)
    (q_2) edge  node {a} (q_3)
    (q_3) edge  node {b} (q_4)          
    (q_4) edge  node {a} (q_5)
    (q_5) edge  node {b} (q_6);
\end{tikzpicture}
\end{center}


Сразу дополним матрицу смежности нетерминалами, выводящими пустую строку, и получим следующую матрицу:

$$
M_2 =
\begin{pmatrix}
[S] & [a] & .   & .   & .   & .   & .   \\
.   & [S] & [b] & .   & .   & .   & .   \\
.   & .   & [S] & [a] & .   & .   & .   \\
.   & .   & .   & [S] & [b] & .   & .   \\
.   & .   & .   & .   & [S] & [a] & .   \\
.   & .   & .   & .   & .   & [S] & [b] \\
.   & .   & .   & .   & .   & .   & [S] 
\end{pmatrix}
$$



\begin{align}
M_3 &= M_1^2 \otimes M_2 = 
\begin{pmatrix}
.   & [a] & .    \\
.   & .   & [S]  \\
[b] & .   & . 
\end{pmatrix}
\otimes 
\begin{pmatrix}
[S] & [a] & .   & .   & .   & .   & .   \\
.   & [S] & [b] & .   & .   & .   & .   \\
.   & .   & [S] & [a] & .   & .   & .   \\
.   & .   & .   & [S] & [b] & .   & .   \\
.   & .   & .   & .   & [S] & [a] & .   \\
.   & .   & .   & .   & .   & [S] & [b] \\
.   & .   & .   & .   & .   & .   & [S] 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c c c c | c c c c c c c | c c c c c c c } 
. & . & . & . & . & . & .  &  . & [a] & . & .   & . & .   & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & [a] & . & .   & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & [a] & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & . \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & [S] & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [S] & . & . & . & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & [S] & . & . & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & [S] & . & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & [S] & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & [S] \\
\hline
. & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & [b] & . & .   & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & .   & . & [b] & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & .   & . & .   & . & [b]  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . 
\end{array}\right)
\end{align}

\newcommand{\tinybf}[1]{\textbf{\tiny{[#1]}}}

Опустим промежуточные шаги вычисления транзитивного замыкания $M_3$ и сразу представим конечный результат:
\begingroup
\setlength\arraycolsep{2pt}
\begin{align}
&tc(M_3)=\notag\\
&
\left(\begin{array}{c c c c c c c | c c c c c c c | c c c c c c c } 
. & . & \tinybf{aSb} & . & \tinybf{aSbaSb} & . & \tinybf{aSbaSbaSb}           &         . & [a] & . & \tinybf{aSba} & . & \tinybf{aSbaSba} & .         &           .   & \tinybf{aS} & .   & \tinybf{aSbaS} & .   & \tinybf{aSbaSbaS} & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & \tinybf{aSb}    & . & \tinybf{aSbaSb}              &         . & .   & . & [a]           & . & \tinybf{aSba}    & .         &           .   & .           & .   & \tinybf{aS}    & .   & \tinybf{aSbaS}    & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & \tinybf{aSb}                 &         . & .   & . & .             & . & [a]              & .         &           .   & .           & .   & .              & .   & \tinybf{aS}       & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
\hline                                                                                              
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           [S] & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & [S]         & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & [S] & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & [S]            & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & [S] & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & [S]               & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & [S] \\
\hline                                                                                              
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & [b]          & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & [b]             & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & [b]                          &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . 
\end{array}\right)
\end{align}
\endgroup


Результирующий граф с новыми рёбрами:
\begin{center}
\begin{tikzpicture}[node distance=2cm,shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_1] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$}; 
   \node[state] (q_4) [right=of q_3] {$4$}; 
   \node[state] (q_5) [right=of q_4] {$5$}; 
   \node[state] (q_6) [right=of q_5] {$6$}; 
    \path[->] 
    (q_0) edge  node {a} (q_1)
    (q_0) edge[bend left, above]  node {\textbf{S}} (q_2)
    (q_0) edge[bend right, above]  node {\textbf{S}} (q_4)
    (q_0) edge[bend right, above]  node {\textbf{S}} (q_6)
    (q_1) edge  node {b} (q_2)
    (q_2) edge  node {a} (q_3)
    (q_2) edge[bend left, above]  node {\textbf{S}} (q_4)
    (q_2) edge[bend right, above]  node {\textbf{S}} (q_6)
    (q_3) edge  node {b} (q_4)          
    (q_4) edge  node {a} (q_5)
    (q_4) edge[bend left, above]  node {\textbf{S}} (q_6)
    (q_5) edge  node {b} (q_6);
\end{tikzpicture}
\end{center}


Его матрица смежности:

$$
M_2 =
\begin{pmatrix}
[S] & [a] & \textbf{[S]} & .   & \textbf{[S]} & .   & \textbf{[S]} \\
.   & [S] & [b]          & .   & .            & .   & .            \\
.   & .   & [S]          & [a] & \textbf{[S]} & .   & \textbf{[S]} \\
.   & .   & .            & [S] & [b]          & .   & .            \\
.   & .   & .            & .   & [S]          & [a] & \textbf{[S]} \\
.   & .   & .            & .   & .            & [S] & [b]          \\
.   & .   & .            & .   & .            & .   & [S] 
\end{pmatrix}
$$

Таким образом видно, что для выбранных входных данных алгоритму достаточно двух итераций основного цикла (вторая итерация будет неполной, достаточно проверить, что результат тензорного произведения не изменился).
Читателю предлагается  выяснить, сколько умножений потребуется, стобы вычислить транзитивное замыкание на первой итерации.

\subsection{Вопросы и задачи}
\begin{enumerate}
\item Оценить пространсвенную сложность алгоритма.
\item Оценить временную сложность алгоритма.
\item Найти библиотеку для тензорного произведения. 
Реализовать алгоритм. 
Можно предпологать, что запросы содержат ограниченное число терминалов и нетерминалов. 
Провести замеры. 
Сравнить с матричным.
\end{enumerate}
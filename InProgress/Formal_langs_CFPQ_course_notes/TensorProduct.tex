\section{Через тензорное произведение}

Предыдущий подход позволяет выразить задачу поиска путей с ограничениями в терминах формальных языков через набор матричных операций.
Это позволяет использовать высокопроизводительные библиотеки и массовопараллельные архитектуры и вообще круто.
Однако, такой подход требует, чтобы грамматика находилась в ослабленной нормальной форме Хомского, что приводит к её разрастанию.
Можно ли как-то избежать этого?

В данном разделе мы попробуем предложить альтернативное сведение задачи поиска путей к матричным операциям.
В результате мы сможем избежать преобразования грамматики в ОНФХ, однако, матрицы, с которыми нам предётся работать, будут существенно б\'{о}льшего размера.

В основе подхода лежит использование рекурсивных сетей или рекурсивных автоматов в качестве представления контекстно-свободных грамматик.

\subsection{Рекурсивные автоматы и сети}

Рекурсивный автомат или сеть --- это представление контекстно-свободных грамматик, обобщающее конечные автоматы.
В нашей работе мы будем придерживаться термина \textbf{рекурсивный автомат}. 
Классическое определение рекурсивного автомата выглядит следующим образом.

\begin{definition}
Рекурсивный автомат --- это кортеж вида $\langle N, \Sigma, S, D \rangle$, где
\begin{itemize}
\item $N$ --- нетерминальный алфавит;
\item $\Sigma$ --- терминальный алфавит;
\item $S$ --- стартовый нетерминал;
\item $D$ --- конечный автомат над $N \cup \Sigma$ в котором стартовые и финальные состояния помечены подмножествами $N$.
\end{itemize}
\end{definition}



Построим рекурсивный автомат для грамматики $G$:
\begin{align*}
S   &\to    A S B \\ 
S   &\to    A B \\
A   &\to    a \\
B   &\to    b
\end{align*}


\begin{align}
\label{input1}
    \begin{tikzpicture}[shorten >=1pt,on grid,auto] 
       \node[state, initial] (q_0)   {$0 \{S\}$}; 
       \node[state] (q_1) [right=of q_0] {$1$}; 
       \node[state] (q_2) [right=of q_1] {$2$}; 
       \node[state, accepting] (q_3) [right=of q_2] {$3\{S\}$};
        \path[->] 
        (q_0) edge  node {a} (q_1)          
        (q_1) edge  node {S} (q_2)
        (q_2) edge  node {b} (q_3)
        (q_1) edge[bend left, above]  node {b} (q_3);
    \end{tikzpicture}
\end{align}

Используем стандартные обозначения для стартовых и финальных состояний. 
Дополнительно в стартовых и финальных состояниях укажем нетерминалы, для которых эти состояния стартовые/финальные.

В некоторых случаях рекурсивный автомат можно рассматривать как конечный автомат над смешанным алфавитом.
Именно такой взгляд мы будем использовать при изложении алгоритма.


\subsection{Тензорное произведение}
\label{section2}

Тензорное произведение матриц или произведение Кронекера --- это бинарная операция, обозначаемая $\otimes$ и определяемая следующим образом.

\begin{definition}
Пусть даны две матрицы: $A$ размера $m\times n$ и $B$ размера $p\times q$.
Произведение Кронекера или тензорное произведение матриц $A$ и $B$ --- это блочная матрица $C$ размера $mp \times nq$, вычисляемая следующим образом:
$$
C = A \otimes B = 
\begin{pmatrix}
A_{0,0}B   & \cdots & A_{0,n-1}B    \\
\vdots     & \ddots & \vdots       \\
A_{m-1,0}B & \cdots &  A_{m-1,n-1}B
\end{pmatrix}
$$
\end{definition}

\newcommand{\examplemtrx}
{
\begin{pmatrix}
5 & 6 & 7 & 8 \\
9 & 10 & 11 & 12 \\
13 & 14 & 15 & 16 
\end{pmatrix}
}

\begin{example}
\begin{align}
\begin{pmatrix}
1 & 2 \\
3 & 4
\end{pmatrix}
\otimes
\examplemtrx &=
\begin{pmatrix}
1\examplemtrx & 2\examplemtrx \\
3\examplemtrx & 4\examplemtrx
\end{pmatrix}
=\notag \\
&=
\left(\begin{array}{c c c c | c c c c}
5  & 6  & 7  & 8  & 10 & 12 & 14 & 16 \\
9  & 10 & 11 & 12 & 18 & 20 & 22 & 24 \\
13 & 14 & 15 & 16 & 26 & 28 & 30 & 32 \\
\hline
15 & 18 & 21 & 24 & 20 & 24 & 28 & 32 \\
27 & 30 & 33 & 36 & 36 & 40 & 44 & 48 \\
39 & 42 & 45 & 48 & 52 & 56 & 60 & 64 
\end{array}\right)
\end{align}
\end{example}

Заметим, что для определения тензорного произведения матриц достаточно определить операцию умножения на элементах исходных матриц.
Также отметим, что произведение Кронекера не является коммутативным.
При этом всегда существуют две матрицы перестоновок $P$ и $Q$ такие, что $A \otimes B = P(B \otimes A)Q$.
Это свойство потребуется нам в дальнейшем.

Теперь перейдём к графам.
Сперва дадим классическое определение тензорного произведения двух неориентированных графов.

\begin{definition}
Пусть даны два графа: $\mathcal{G}_1 = \langle V_1, E_1\rangle$ и $\mathcal{G}_2 = \langle V_2, E_2\rangle$. 
Тензорным произведением этих графов будем называть граф $\mathcal{G}_3 = \langle V_3, E_3\rangle$, где $V_3 = V_1 \times V_2$, $E_3 = \{ ((v_1,v_2),(u_1,u_2)) \mid (v_1,u_1) \in E_1 \text{ и } (v_2,u_2) \in E_2 \}$.
\end{definition}

Иными словами, тензорным произведением двух графов является граф, такой что:
\begin{enumerate}
 \item множество вершин --- это прямое произведение множеств вершин исходных графов;
 \item ребро между вершинами $v=(v_1,v_2)$ и $u=(u_1,u_2)$ существует тогда и только тогда, когда существуют рёбра между парами вершин $v_1$, $u_1$ и $v_2$, $u_2$ в соответсвующих графах. 
\end{enumerate}

Для того, чтобы построить тензорное произведение ориентированных графов, необходимо в предыдущем определении, в условии существования ребра в результирующем графе, дополнительно потребовать, чтобы направления рёбер совпадали.
Данное требование получается естесвенным образом, если считать, что пары вершин, задающие ребро, упорядочены, поэтому формальное определение отличаться не будет.

Осталось добавить метки к рёбрам.
Это приведёт к логичному усилению требованя к существованию ребра: метки рёбер в исходных графах должны совпадать.
Таким образом, мы получаем следующее определение тензорного произведения ориентированных графов с метками на рёбрах.

\begin{definition}
Пусть даны два ориентированных графа с метками на рёбрах: $\mathcal{G}_1 = \langle V_1, E_1, L_1 \rangle$ и $\mathcal{G}_2 = \langle V_2, E_2, L_2 \rangle$.
Тензорным произведением этих графов будем называть граф $\mathcal{G}_3 = \langle V_3, E_3, L_3\rangle$, где $V_3 = V_1 \times V_2$, $E_3 = \{ ((v_1,v_2),l,(u_1,u_2)) \mid (v_1,l,u_1) \in E_1 \text{ и } (v_2,l,u_2) \in E_2 \}$, $L_3=L_1 \cap L_2$.
\end{definition}

Нетрудно заметить, что матрица смежности графа $\mathcal{G}_3$ равна тензорному произведению матриц смежностей исходных графов $\mathcal{G}_1$ и $\mathcal{G}_2$.

\begin{example}
Рассмотрим пример.
В качестве одного из графов возьмём рекурсивный автомат, построенный ранее (изображение~\ref{input1}).
Его матрица смежности выглядит следующим образом.
$$ M_1 =
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
$$
\end{example}


\begin{align}
\label{input2}
    \begin{tikzpicture}[shorten >=1pt,on grid,auto] 
       \node[state] (q_0)   {$0$}; 
       \node[state] (q_1) [above right=of q_0] {$1$}; 
       \node[state] (q_2) [right=of q_0] {$2$}; 
       \node[state] (q_3) [right=of q_2] {$3$};
        \path[->] 
        (q_0) edge  node {a} (q_1)          
        (q_1) edge  node {a} (q_2)
        (q_2) edge  node {a} (q_0)
        (q_2) edge[bend left, above]  node {b} (q_3)
        (q_3) edge[bend left, below]  node {b} (q_2);
    \end{tikzpicture}
\end{align}

Второй граф представлен на изображении~\ref{input2}. 
Его матрица смежности имеет следующий вид.
$$ M_2 =
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [a] & . \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
$$

Теперь вычислим $M_1 \otimes M_2$.
\begin{align}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [a] & . \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\label{eq:graph_tm}
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  .   & [a] & .   & .  &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  .   & .   & [a] & .  &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  [a] & .   & .   & .  &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  .   & .   & .   & .  &  . & . & . & .  &  . & . & . & .   \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & . 
\end{array}\right)
\end{align}

Побалуемся с некоммутативностью и перестановками.

\subsection{Алгоритм}

Идея алгоритма основана на обобщении пересечения двух конечных автоматов до пересечения рекурсивного автомата, построенного по грамматике, со входным графом.

Пересечение двух конечных автоматов --- тензорное произведение соответствующих графов.
Пересечение языков коммутативно, тензорное произведение нет, но это не страшно.

В итоговом автомате для любого нетерминала должен существовать хотя бы один путь из правильного стартового состояния в финальное, содержащий только терминалы.
Если это не так, то данная грамматика непорождающая, то есть она не может породить ни одной цепочки, содержайщей только терминалы.
Это делает задачу бессодержательной.
% Несколько наблюдений.
% Путь из нетерминалов и терминалов.
% При этом должны быть пути из терминалов. Иначе не задать язык.
% Будем насыщать граф рёбрами, помеченными нетерминалами.

\begin{algorithm}
  \floatname{algorithm}{Listing}
\begin{algorithmic}[1]
\caption{Поиск путей через тензорное произведение}
\label{lst:algo1}
\Function{contextFreePathQueryingTP}{G, $\mathcal{G}$}
    \State{$R \gets$ рекурсивный автомат для $G$}
    \State{$N \gets$ нетерминальный алфавит для $R$}
    \State{$S \gets$ стартовые состояния для $R$}
    \State{$F \gets$ конечные состояния для $R$}
    \State{$M_1 \gets$ матрица смежности $R$}
    \State{$M_2 \gets$ матрица смежности $\mathcal{G}$}
    \While{матрица $M_2$ изменяется}
        \State{$M_3 \gets M_1 \otimes M_2$}
        \Comment{Пересечение графов}
        \State{$tC_3 \gets \textit{transitiveClosure}(M_3)$}
        \For{$i \in 0..m$}
           \For{$j \in 0..n$}
           \Comment{$m \times n$ - размер матрицы $M_3$}
                \If{$tC_3[i,j]$}
                    \State{$s \gets$ стартовая вершина ребра $tC_3[i,j]$}
                    \State{$f \gets$ конечная вершина ребра $tC_3[i,j]$}
                    \If{$s \in S$ and $f \in F$ }
                        \State{$x, y \gets$ $getCoordinates(i,j)$}
                        \State{$M_2[x,y] \gets M_2[x,y] \cup \{getNonterminals(s,f)\}$}
                    \EndIf
                \EndIf
           \EndFor
        \EndFor
    \EndWhile
\State \Return $M_2$
\EndFunction
\end{algorithmic}
\end{algorithm}


Алгоритм исполняется до тех пор, пока матрица смежности $M_2$ изменяется. 
На каждой итерации цикла алгоритм последовательно проделывает следующие команды: пересечение двух автоматов через тензорное произведение, транзитивное замыкание результата тензорного произведения и итерация по всем ячейкам получившейся после транзитивного замыкания матрицы.
Во время итерации по ячейкам матрицы транзитивного замыкания алгоритм сначала проверяет наличие ребра в данной ячейке, а затем - принадлежность стартовой и конечной вершин ребра к стартовому и конечному состоянию входного рекурсивного автомата. 
При удовлетворении этих условий алгоритм добавляет нетерминал/нетерминалы, соответствующие стартовой и конечной вершинам ребра, в ячейку матрицы $M_2$, полученной с благодаря функции $getCoordinates(i,j)$.


Вместо того, чтобы перезаписывать каждый раз матрицу смежности $M_2$ можно вычислять только разницу.
Для этого, правда, потребуется хранить в памяти ещё одну матрицу.
Также для данной реализации надо проверять, что вычислительно дешевле: поддерживать разницу и потом каждый раз поэлементно складывать две матрицы или каждый раз вычислять полностью произведение.


Отметим, что для реальных графов и запросов результат тензорного произведения будет очень разрежен.
Таким образом на готовых либах вычисление должно быть быстро.

\subsection{Примеры}

Рассмотрим подробно ряд примеров работы описанного алгоритма. 
Будем для каждой итерации внешнего цикла выписывать результаты основных операций: тензорного произведения, транзитивного замыкания, обновления матрицы смежности входного графа.
Новые, по сравнению с предыдущим состоянием, элементы матриц будем выделять жирным.

\begin{example}
\label{algorithm_example}
Теоретически худший случай.
Такой же как и для матричного.

\textbf{Итерация 1 (конец).} Начало в разделе~\ref{section2}, где мы вычислили тензорное произведение матриц смежности.
Теперь нам осталось только вычислить транзитивное замыкание полученной матрицы.
 
\begin{align}
tc(M_3) =
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .  &  . & . & . & .\\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .  &  . & . & . & \textbf{[ab]}   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .  &  . & . & . & . 
\end{array}\right)
\end{align}

Мы видим, что в результате транзитивного замыкания появилось новое ребро с меткой $ab$ из вершины $(0,1)$ в вершину $(3,3)$.
Так как вершина 0 является стартовой в рекурсивном автомате, а 3 является финальной, то слово вдоль пути из вершины 1 в вершину 3 во входном графе выводимо из нетерминала $S$.
Это означает, что в графе должно быть добавлено ребро из $0$ в $3$ с меткой $S$, после чего граф будет выглядеть следующим образом:

\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a} (q_2)
    (q_2) edge  node {a} (q_0)
    (q_1) edge[bend left, above]  node {\textbf{S}} (q_3)
    (q_2) edge[bend left, above]  node {b} (q_3)
    (q_3) edge[bend left, below]  node {b} (q_2);
\end{tikzpicture}
\end{center}

Матрица смежности обновлённого графа:
$$ M_2 =
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [a] & \textbf{[S]} \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
$$

Итерация закончена. 
Возвращаемся к началу цикла и вновь вычисляем тензорное произведение.

\textbf{Итерация 2.}
Вычисляем тензорное произведение матриц смежности.

\begin{align}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [a] & [S] \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & \textbf{[S]}  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & . 
\end{array}\right)
\end{align}

Вычисляем транзитивное замыкание полученной матрицы:

\begin{align}
tc(M_3) =
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & \textbf{[aS]}  &  . & . & \textbf{[aSb]} & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .              &  . & . & .              & [ab]   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .              &  . & . & .              & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & .              & .   \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & [S]            &  . & . & \textbf{[Sb]}    & .    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & .    & [b]  \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b]  & .    \\
\hline                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b] & . \\
\hline                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & . 
\end{array}\right)
\end{align}

В транзитивном замыкании появилось три новых ребра, однако только одно из них соединяет вершины, соответствующие стартовому и конечному состоянию входного рекурсивного автомата.
Таким образом только это ребро должно быть добавлено во входной граф.
В итоге, обновлённый граф:
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a} (q_2)
    (q_2) edge  node {a} (q_0)
    (q_1) edge[bend left, above]  node {S} (q_3)
    (q_0) edge[bend right, below]  node {\textbf{S}} (q_2)
    (q_2) edge[bend left, above]  node {b} (q_3)
    (q_3) edge[bend left, below]  node {b} (q_2);
\end{tikzpicture}
\end{center}

И его матрица смежности:

$$ M_2 =
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a] & [S] \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
$$

\textbf{Итерация 3.}
Снова начинаем с тензорного произведения.

\begin{align}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a] & [S] \\
[a] & . & . & [b] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & \textbf{[S]} & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & [S]  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .    &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & . 
\end{array}\right)
\end{align}

Затем вычисляем транзитивное замыкание:

\begin{align}
tc(M_3) =
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & [aS]           &  . & . & [aSb] & .     \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .              &  . & . & .     & [ab]  \\
. & . & . & .  &  [a] & . & . & .  &  . & . & \textbf{[aS]} & .  &  . & . & .     & \textbf{[aSb]} \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & .     & .     \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & [S] & .            &  . & . & .    & \textbf{[Sb]}    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & [S]            &  . & . & [Sb] & .    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & .    & [b]  \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b]  & .    \\
\hline                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b] & . \\
\hline                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & . 
\end{array}\right)
\end{align}

И наконец обновляем граф:
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a} (q_2)
    (q_2) edge  node {a} (q_0)
    (q_1) edge[bend left, above]  node {S} (q_3)
    (q_0) edge[bend right, below]  node {S} (q_2)
    (q_2) edge[bend left, above]  node {b,\textbf{S}} (q_3)
    (q_3) edge[bend left, below]  node {b} (q_2);
\end{tikzpicture}
\end{center}

Матрица смежности обновлённого графа:

$$ M_2 =
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a] & [S] \\
[a] & . & . & [b, \textbf{S}] \\
. & . & [b] & . 
\end{pmatrix}
$$

Уже можно заметить закономерность: на каждой итерации мы добавляем ровно одно новое ребро во входной граф.
То есть находим ровно одну новую пару вешин, между которыми существует интересующий нас путь.
Попробуйте спрогонозировать, сколько итераций нам ещё осталось сделать.

\textbf{Итерауия 4}.
Продолжаем. Вычисляем тензорное произведение.

\begin{align}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a] & [S] \\
[a] & . & . & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & [S] & .             &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & [S]           &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & \textbf{[S]}  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .             &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & . 
\end{array}\right)
\end{align}

Затем транзитивное замыкание:

\begin{align}
tc(M_3) =
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & [aS]           &  . & . & [aSb]          & .     \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & \textbf{[aS]}  &  . & . & \textbf{[aSb]} & [ab]  \\
. & . & . & .  &  [a] & . & . & .  &  . & . & [aS] & .           &  . & . & .              & [aSb] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & .              & .     \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & [S] & .            &  . & . & .             & [Sb]    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & [S]            &  . & . & [Sb]          & .    \\
. & . & . & .  &  . & . & . & .    &  . & . & . & [S]            &  . & . & \textbf{[Sb]} & [b]  \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b]           & .    \\
\hline                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & [b] & . \\
\hline                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .              &  . & . & . & . 
\end{array}\right)
\end{align}

И снова обновляем граф, так как в транзитивном замыкании появился один (и снова ровно один) новый элемент, соответствующий принимающему пути в автомате.
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a,\textbf{S}} (q_2)
    (q_2) edge  node {a} (q_0)
    (q_1) edge[bend left, above]  node {S} (q_3)
    (q_0) edge[bend right, below]  node {S} (q_2)
    (q_2) edge[bend left, above]  node {b,S} (q_3)
    (q_3) edge[bend left, below]  node {b} (q_2);
\end{tikzpicture}
\end{center}
  

Матрица смежности обновлённого графа:

$$ M_2 =
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a, \textbf{S}] & [S] \\
[a] & . & . & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
$$

\textbf{Итерация 5.}
Приступаем к выполнению следующей итерации основного цикла.
Вычисляем тензорное произведение.


\begin{align}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & [S] & . \\
. & . & [a,S] & [S] \\
[a] & . & . & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & [S]          & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & \textbf{[S]} & [S]  &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .            & [S]  &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & .            & .    &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & . 
\end{array}\right)
\end{align}

Затем вычисляем транзитивное замыкание:

\begin{align}
tc(M_3) =
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & \textbf{[aS]} & [aS]  &  . & . & [aSb] & \textbf{[aSb]}  \\
. & . & . & .  &  . & . & [a] & .  &  . & . & .             & [aS]  &  . & . & [aSb] & [ab]          \\
. & . & . & .  &  [a] & . & . & .  &  . & . & [aS]          & .     &  . & . & .     & [aSb]         \\
. & . & . & .  &  . & . & . & .    &  . & . & .             & .     &  . & . & .     & .             \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & [S] & .             &  . & . & .    & [Sb]    \\
. & . & . & .  &  . & . & . & .    &  . & . & [S] & [S]           &  . & . & [Sb] & \textbf{[Sb]}    \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & [S]           &  . & . & [Sb] & [b]  \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .             &  . & . & [b]  & .    \\
\hline                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & [b]  & . \\
\hline                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & . 
\end{array}\right)
\end{align}

Обновляем граф:
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a,S} (q_2)
    (q_2) edge[bend right, above]  node {a} (q_0)
    (q_1) edge[bend left, above]  node {S} (q_3)
    (q_0) edge[bend right, above]  node {S} (q_2)
    (q_2) edge[bend left, above]  node {b,S} (q_3)
    (q_0) edge[bend right, below]  node {\textbf{S}} (q_3)
    (q_3) edge[bend left, above]  node {b} (q_2);
\end{tikzpicture}
\end{center}
  

Матрица смежности обновлённого графа:

$$ M_2 =
\begin{pmatrix} 
. & [a] & [S] & \textbf{[S]} \\
. & . & [a, S] & [S] \\
[a] & . & . & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
$$

\textbf{Итерация 6.}
И наконец последняя содержательная итерация основного цикла.

\begin{align}
M_3 &= M_1 \otimes M_2 = 
\begin{pmatrix} 
. & [a] & . & . \\
. & . & [S] & [b] \\
. & . & . & [b] \\
. & . & . & . 
\end{pmatrix}
\otimes 
\begin{pmatrix} 
. & [a] & [S] & [S] \\
. & . & [a,S] & [S] \\
[a] & . & . & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & [a] & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  [a] & . & . & .  &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & [S] & \textbf{[S]}    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & [S] & [S]             &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & [S]             &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .               &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & [b] & . \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .    &  . & . & . & . 
\end{array}\right)
\end{align}

Транзитивное замыкание:

\begin{align}
tc(M_3) =
\left(\begin{array}{c c c c | c c c c | c c c c | c c c c } 
. & . & . & .  &  . & [a] & . & .  &  . & . & [aS] & [aS]           &  . & . & [aSb]          & [aSb]  \\
. & . & . & .  &  . & . & [a] & .  &  . & . & .    & [aS]           &  . & . & [aSb]          & [ab]          \\
. & . & . & .  &  [a] & . & . & .  &  . & . & [aS] & \textbf{[aS]}  &  . & . & \textbf{[aSb]} & [aSb]         \\
. & . & . & .  &  . & . & . & .    &  . & . & .    & .              &  . & . & .              & .             \\
\hline
. & . & . & .  &  . & . & . & .    &  . & . & [S] & \texttt{[S]}    &  . & . & \textbf{[Sb]}  & [Sb]    \\
. & . & . & .  &  . & . & . & .    &  . & . & [S] & [S]             &  . & . & [Sb] & [Sb]    \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & [S]             &  . & . & [Sb] & [b]  \\
. & . & . & .  &  . & . & . & .    &  . & . & .   & .               &  . & . & [b]  & .    \\
\hline                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & .    & [b] \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & [b]  & . \\
\hline                                                              
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & .   \\
. & . & . & .  &  . & . & . & .    &  . & . & . & .               &  . & . & . & . 
\end{array}\right)
\end{align}

Обновлённый граф:
\begin{center}
\begin{tikzpicture}[shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$};
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {a,S} (q_2)
    (q_2) edge[bend right, above]  node {a} (q_0)
    (q_2) edge[loop right]  node {\textbf{S}} (q_2)
    (q_1) edge[bend left, above]  node {S} (q_3)
    (q_0) edge[bend right, above]  node {S} (q_2)
    (q_2) edge[bend left, above]  node {b,S} (q_3)
    (q_0) edge[bend right, below]  node {S} (q_3)
    (q_3) edge[bend left, above]  node {b} (q_2);
\end{tikzpicture}
\end{center}
  

И матрица смежности:

$$ M_2 =
\begin{pmatrix} 
. & [a] & [S] & [S] \\
. & . & [a, S] & [S] \\
[a] & . & \textbf{[S]} & [b,S] \\
. & . & [b] & . 
\end{pmatrix}
$$


Следующая итерация не приведёт к изменению графа.
Читатель может убедиться в этом самостоятельно.
Соответственно, алгоритм можно завершать.
Нам потребовалось семь итераций (шесть содержательных и одна проверочная).

Матрица смежности получилась такая же, как и раньше, ответ правильный.
Мы видим, что количество итераций внешнего цикла такое же как и у алгоритма CYK (пример~\ref{CYK_algorithm_ex}).
И ещё что-то видим и можем понять.

\end{example}


\begin{example}

В данном примере мы увидим, как структура грамматики и, соответственно, рекурсивного автомата, влияет на процесс вычислений.

Интуитивно понятно, что чем меньше состояний в рекурсивной сети, тем лучше.
То есть желательно получить как можно более компактное описание контекстно-свободного языка.

Для примера возьмём в качестве КС языка язык Дика на одном типе скобок и опишем его двумя различными грамматиками.
Первая граммтика классическая:
$$
G_1 = \langle \{a,\ b\}, \{ S \}, \{S \to a \ S \ b \ S \mid \varepsilon  \} \rangle
$$

Во второй грамматике мы будем использовать конструкции регулярных выражений в правой части правил.
То есть вторая грамматика находитмся в EBNF (Расширенная форма Бэкуса-Наура~\cite{Hemerik2009, Wirth1977}).
$$
G_2 = \langle \{a, \ b\}, \{S\}, \{S \to (a \ S \ b)^{*}\} \rangle
$$

Построим рекурсивные автоматы $N_1$ и $N_2$ и их матрицы смежности для этих грамматик.

Рекурсивный автомат $N_1$ для грамматики $G_1$:
\begin{center}
\begin{tikzpicture}[node distance=2cm,shorten >=1pt,on grid,auto] 
   \node[state, initial, accepting] (q_0)   {$0$}; 
   \node[state] (q_1) [right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_1] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$}; 
   \node[state, accepting] (q_4) [right=of q_3] {$4$}; 
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {S} (q_2)
    (q_2) edge  node {b} (q_3)
    (q_3) edge  node {S} (q_4);
\end{tikzpicture}
\end{center}

Матрица смежности $N_1$:

$$
M_1^1 =
\begin{pmatrix}
. & [a] & .   & .   & .  \\
. & .   & [S] & .   & .  \\
. & .   & .   & [b] & .  \\
. & .   & .   & .   & [S] \\
. & .   & .   & .   & .
\end{pmatrix}
$$


Рекурсивный автомат $N_2$ для грамматики $G_2$:
\begin{center}
\begin{tikzpicture}[node distance=3cm,shorten >=1pt,on grid,auto] 
   \node[state, initial, accepting] (q_0)   {$0$}; 
   \node[state] (q_1) [above right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_0] {$2$}; 
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {S} (q_2)
    (q_2) edge  node {b} (q_0);
\end{tikzpicture}
\end{center}

Матрица смежности $N_2$:

$$
M_1^2 =
\begin{pmatrix}
.   & [a] & .    \\
.   & .   & [S]  \\
[b] & .   & . 
\end{pmatrix}
$$


Первое очевидное наблюдение --- количество состояний в $N_2$ меньше, чем в $N_1$.
Это значит, что матрицы будут меньше, считать быстрее.

Для того, чтобы проще было сделать второе, сперва выполним пошагово алгоритм для двух заданных рекурсивных сетей.

Вход возьмём линейный:
\begin{center}
\begin{tikzpicture}[node distance=2cm,shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_1] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$}; 
   \node[state] (q_4) [right=of q_3] {$4$}; 
   \node[state] (q_5) [right=of q_4] {$5$}; 
   \node[state] (q_6) [right=of q_5] {$6$}; 
    \path[->] 
    (q_0) edge  node {a} (q_1)          
    (q_1) edge  node {b} (q_2)
    (q_2) edge  node {a} (q_3)
    (q_3) edge  node {b} (q_4)          
    (q_4) edge  node {a} (q_5)
    (q_5) edge  node {b} (q_6);
\end{tikzpicture}
\end{center}


Сразу дополним матрицу смежности нетерминалами, выводящими пустую строку, и получим следующую матрицу:

$$
M_2 =
\begin{pmatrix}
[S] & [a] & .   & .   & .   & .   & .   \\
.   & [S] & [b] & .   & .   & .   & .   \\
.   & .   & [S] & [a] & .   & .   & .   \\
.   & .   & .   & [S] & [b] & .   & .   \\
.   & .   & .   & .   & [S] & [a] & .   \\
.   & .   & .   & .   & .   & [S] & [b] \\
.   & .   & .   & .   & .   & .   & [S] 
\end{pmatrix}
$$

Сперва запустим алгоритм на входе и $N_2$. 
Первый шаг первой итерации --- вычисление тензорного произведения $M_1^2 \otimes M_2$.

\begin{align}
M_3 &= M_1^2 \otimes M_2 = 
\begin{pmatrix}
.   & [a] & .    \\
.   & .   & [S]  \\
[b] & .   & . 
\end{pmatrix}
\otimes 
\begin{pmatrix}
[S] & [a] & .   & .   & .   & .   & .   \\
.   & [S] & [b] & .   & .   & .   & .   \\
.   & .   & [S] & [a] & .   & .   & .   \\
.   & .   & .   & [S] & [b] & .   & .   \\
.   & .   & .   & .   & [S] & [a] & .   \\
.   & .   & .   & .   & .   & [S] & [b] \\
.   & .   & .   & .   & .   & .   & [S] 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c c c c | c c c c c c c | c c c c c c c } 
. & . & . & . & . & . & .  &  . & [a] & . & .   & . & .   & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & [a] & . & .   & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & [a] & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & . \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & . & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & [S] & . & . & . & . & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [S] & . & . & . & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & [S] & . & . & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & [S] & . & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & [S] & . \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & [S] \\
\hline
. & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & [b] & . & .   & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & .   & . & [b] & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & .   & . & .   & . & [b]  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . \\
. & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & . 
\end{array}\right)
\end{align}

\newcommand{\tinybf}[1]{\textbf{\tiny{[#1]}}}
\newcommand{\tntm}[1]{\text{\tiny{#1}}}

Опустим промежуточные шаги вычисления транзитивного замыкания $M_3$ и сразу представим конечный результат:
\begingroup
\setlength\arraycolsep{2pt}
\begin{align}
&tc(M_3)=\notag\\
&
\left(\begin{array}{c c c c c c c | c c c c c c c | c c c c c c c } 
. & . & \tinybf{aSb} & . & \tinybf{aSbaSb} & . & \tinybf{aSbaSbaSb}           &         . & [a] & . & \tinybf{aSba} & . & \tinybf{aSbaSba} & .         &           .   & \tinybf{aS} & .   & \tinybf{aSbaS} & .   & \tinybf{aSbaSbaS} & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & \tinybf{aSb}    & . & \tinybf{aSbaSb}              &         . & .   & . & [a]           & . & \tinybf{aSba}    & .         &           .   & .           & .   & \tinybf{aS}    & .   & \tinybf{aSbaS}    & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & \tinybf{aSb}                 &         . & .   & . & .             & . & [a]              & .         &           .   & .           & .   & .              & .   & \tinybf{aS}       & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
\hline                                                                                              
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           [S] & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & [S]         & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & [S] & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & [S]            & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & [S] & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & [S]               & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & [S] \\
\hline                                                                                              
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & [b]          & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & [b]             & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & [b]                          &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . \\
. & . & .            & . & .               & . & .                            &         . & .   & . & .             & . & .                & .         &           .   & .           & .   & .              & .   & .                 & . 
\end{array}\right)
\end{align}
\endgroup

В результате вычисления транзитивного замыкания появилось большое количество новых рёбер, однако нас будут интересновать только те, информация о которых храниться в левом верхнем блоке.
Остальные рёбра не соответствуют принимающим путям в рекурсивном автомате (убедитесь в этом самостоятельно).

После добавления соответствующих рёбер, мы получим следующий граф:
\begin{center}
\begin{tikzpicture}[node distance=2cm,shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_1] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$}; 
   \node[state] (q_4) [right=of q_3] {$4$}; 
   \node[state] (q_5) [right=of q_4] {$5$}; 
   \node[state] (q_6) [right=of q_5] {$6$}; 
    \path[->] 
    (q_0) edge  node {a} (q_1)
    (q_0) edge[bend left, above]  node {\textbf{S}} (q_2)
    (q_0) edge[bend right, above]  node {\textbf{S}} (q_4)
    (q_0) edge[bend right, above]  node {\textbf{S}} (q_6)
    (q_1) edge  node {b} (q_2)
    (q_2) edge  node {a} (q_3)
    (q_2) edge[bend left, above]  node {\textbf{S}} (q_4)
    (q_2) edge[bend right, above]  node {\textbf{S}} (q_6)
    (q_3) edge  node {b} (q_4)          
    (q_4) edge  node {a} (q_5)
    (q_4) edge[bend left, above]  node {\textbf{S}} (q_6)
    (q_5) edge  node {b} (q_6);
\end{tikzpicture}
\end{center}


Его матрица смежности:

$$
M_2 =
\begin{pmatrix}
[S] & [a] & \textbf{[S]} & .   & \textbf{[S]} & .   & \textbf{[S]} \\
.   & [S] & [b]          & .   & .            & .   & .            \\
.   & .   & [S]          & [a] & \textbf{[S]} & .   & \textbf{[S]} \\
.   & .   & .            & [S] & [b]          & .   & .            \\
.   & .   & .            & .   & [S]          & [a] & \textbf{[S]} \\
.   & .   & .            & .   & .            & [S] & [b]          \\
.   & .   & .            & .   & .            & .   & [S] 
\end{pmatrix}
$$

Таким образом видно, что для выбранных входных данных алгоритму достаточно двух итераций основного цикла: первая содержательная, вторая, как обычно, проверочная.
Читателю предлагается самостоятельно выяснить, сколько умножений матриц потребуется, чтобы вычислить транзитивное замыкание на первой итерации.

Теперь запустим алгоритм на второй грамматике и том же входе.

\begingroup
\setlength\arraycolsep{2pt}
\begin{align}
&M_3 = M_1^1 \otimes M_2 = 
\begin{pmatrix}
. & [a] & .   & .   & .  \\
. & .   & [S] & .   & .  \\
. & .   & .   & [b] & .  \\
. & .   & .   & .   & [S] \\
. & .   & .   & .   & .
\end{pmatrix}
\otimes 
\begin{pmatrix}
[S] & [a] & .   & .   & .   & .   & .   \\
.   & [S] & [b] & .   & .   & .   & .   \\
.   & .   & [S] & [a] & .   & .   & .   \\
.   & .   & .   & [S] & [b] & .   & .   \\
.   & .   & .   & .   & [S] & [a] & .   \\
.   & .   & .   & .   & .   & [S] & [b] \\
.   & .   & .   & .   & .   & .   & [S] 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c} 
. & . & . & . & . & . & .  &  . & [a] & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & [a] & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & [a] & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & [S] & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [S] & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & [S] & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & [S] & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & [S] & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & [S]  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [b] & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & [b] & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & [b]  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & [S] & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [S] & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & [S] & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & [S] & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & [S] & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & [S]   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   
\end{array}\right)
\end{align}
\endgroup

Уже сейчас можно заметить, что размер матриц, с которыми нам придётся работать, существенно увеличился, по сравнению с предыдущим вариантом.
Это, конечно, закономерно, ведь в рекурсивном автомате для предыдущего варианта меньше состояний, а значит и матрица смежности имеет меньший размер.

Транзитивное замыкание:
\begingroup
\setlength\arraycolsep{1pt}
\begin{align}
&tc(M_3)=\notag\\
&=
\left(\begin{array}{c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c} 
. & . & . & . & . & . & .   &   . & [a] & . & .   & . & .   & .   &   . & \tinybf{aS} & . & .           & . & .           & .  &  . & . & \tinybf{aSb} & . & .            & . & .             &  . & . & \tinybf{aSbS} & . & .             & . & .   \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .   \\
. & . & . & . & . & . & .   &   . & .   & . & [a] & . & .   & .   &   . & .           & . & \tinybf{aS} & . & .           & .  &  . & . & .            & . & \tinybf{aSb} & . & .             &  . & . & .             & . & \tinybf{aSbS} & . & .   \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .   \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & [a] & .   &   . & .           & . & .           & . & \tinybf{aS} & .  &  . & . & .            & . & .            & . & \tinybf{aSb}  &  . & . & .             & . & .             & . & \tinybf{aSbS}   \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .   \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .   \\
\hline                                                                                
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   [S] & .   & .   & .   & .   & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & [S] & .   & .   & .   & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & [S] & .   & .   & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & [S] & .   & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & .   & [S] & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & .   & .   & [S] & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & .   & .   & .   & [S]  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
\hline                                                                                
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [b] & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & [b] & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & [b]  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & [S] & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [S] & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & [S] & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & [S] & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & [S] & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & [S]   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   
\end{array}\right)
\end{align}
\endgroup

Обновлённый граф:
\begin{center}
\begin{tikzpicture}[node distance=2cm,shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_1] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$}; 
   \node[state] (q_4) [right=of q_3] {$4$}; 
   \node[state] (q_5) [right=of q_4] {$5$}; 
   \node[state] (q_6) [right=of q_5] {$6$}; 
    \path[->] 
    (q_0) edge  node {a} (q_1)
    (q_0) edge[bend left, above]  node {\textbf{S}} (q_2)
    (q_1) edge  node {b} (q_2)
    (q_2) edge  node {a} (q_3)
    (q_2) edge[bend left, above]  node {\textbf{S}} (q_4)
    (q_3) edge  node {b} (q_4)          
    (q_4) edge  node {a} (q_5)
    (q_4) edge[bend left, above]  node {\textbf{S}} (q_6)
    (q_5) edge  node {b} (q_6);
\end{tikzpicture}
\end{center}


Его матрица смежности:

$$
M_2 =
\begin{pmatrix}
[S] & [a] & \textbf{[S]} & .   & .            & .   & .            \\
.   & [S] & [b]          & .   & .            & .   & .            \\
.   & .   & [S]          & [a] & \textbf{[S]} & .   & .            \\
.   & .   & .            & [S] & [b]          & .   & .            \\
.   & .   & .            & .   & [S]          & [a] & \textbf{[S]} \\
.   & .   & .            & .   & .            & [S] & [b]          \\
.   & .   & .            & .   & .            & .   & [S] 
\end{pmatrix}
$$

Потребуется ещё одна итерация.

\begingroup
\setlength\arraycolsep{2pt}
\begin{align}
&M_3 = M_1^1 \otimes M_2 = 
\begin{pmatrix}
. & [a] & .   & .   & .  \\
. & .   & [S] & .   & .  \\
. & .   & .   & [b] & .  \\
. & .   & .   & .   & [S] \\
. & .   & .   & .   & .
\end{pmatrix}
\otimes 
\begin{pmatrix}
[S] & [a] & [S] & .   & .   & .   & .   \\
.   & [S] & [b] & .   & .   & .   & .   \\
.   & .   & [S] & [a] & [S] & .   & .   \\
.   & .   & .   & [S] & [b] & .   & .   \\
.   & .   & .   & .   & [S] & [a] & [S] \\
.   & .   & .   & .   & .   & [S] & [b] \\
.   & .   & .   & .   & .   & .   & [S] 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c} 
. & . & . & . & . & . & .  &  . & [a] & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & [a] & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & [a] & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & .   & \textbf{[S]} & .   & .            & .   & .             &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & [S] & .            & .   & .            & .   & .             &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & [S]          & .   & \textbf{[S]} & .   & .             &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .            & [S] & .            & .   & .             &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .            & .   & [S]          & .   & \textbf{[S]}  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .            & .   & .            & [S] & .             &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .            & .   & .            & .   & [S]           &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [b] & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & [b] & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & [b]  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & .   & \textbf{[S]} & .   & .            & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & [S] & .            & .   & .            & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & [S]          & .   & \textbf{[S]} & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .            & [S] & .            & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .            & .   & [S]          & .   & \textbf{[S]}   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .            & .   & .            & [S] & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .            & .   & .            & .   & [S]   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   
\end{array}\right)
\end{align}
\endgroup

Транзитивное замыкание:
\begingroup
\setlength\arraycolsep{1pt}
\begin{align}
&tc(M_3)=\notag\\
&=
\left(\begin{array}{c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c} 
. & . & . & . & . & . & .   &   . & [a] & . & .   & . & .   & .   &   . & \tntm{[aS]} & . & \tinybf{aS} & . & .           & .  &  . & . & \tntm{[aSb]} & . & \tinybf{aSb} & . & .             &  . & . & \tntm{[aSbS]} & . & \tinybf{aSbS} & . & .               \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .               \\
. & . & . & . & . & . & .   &   . & .   & . & [a] & . & .   & .   &   . & .           & . & \tntm{[aS]} & . & \tinybf{aS} & .  &  . & . & .            & . & \tntm{[aSb]} & . & \tinybf{aSb}  &  . & . & .             & . & \tntm{[aSbS]} & . & \tinybf{aSbS}   \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .               \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & [a] & .   &   . & .           & . & .           & . & \tntm{[aS]} & .  &  . & . & .            & . & .            & . & \tntm{[aSb]}  &  . & . & .             & . & .             & . & \tntm{[aSbS]}   \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .               \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .               \\
\hline                                                                                
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   [S] & .   & [S] & .   & .   & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & [S] & .   & .   & .   & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & [S] & .   & [S] & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & [S] & .   & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & .   & [S] & .   & [S]  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & .   & .   & [S] & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & .   & .   & .   & [S]  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
\hline                                                                                
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [b] & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & [b] & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & [b]  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & .   & [S] & .   & .   & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & [S] & .   & .   & .   & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & [S] & .   & [S] & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & [S] & .   & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & [S] & .   & [S]   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & .   & [S] & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & .   & .   & [S]   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   
\end{array}\right)
\end{align}
\endgroup

Обновлённый граф:

На этом шаге мы смогли ``склеить'' из подстрок, выводимых из $S$, более длинные пути.
Однако, согласно правилам грамматики, мы смогли ``скленить'' только две подстроки в единое целое.

\begin{center}
\begin{tikzpicture}[node distance=2cm,shorten >=1pt,on grid,auto] 
   \node[state] (q_0)   {$0$}; 
   \node[state] (q_1) [right=of q_0] {$1$}; 
   \node[state] (q_2) [right=of q_1] {$2$}; 
   \node[state] (q_3) [right=of q_2] {$3$}; 
   \node[state] (q_4) [right=of q_3] {$4$}; 
   \node[state] (q_5) [right=of q_4] {$5$}; 
   \node[state] (q_6) [right=of q_5] {$6$}; 
    \path[->] 
    (q_0) edge  node {a} (q_1)
    (q_0) edge[bend left, above]  node {S} (q_2)
    (q_0) edge[bend right, above]  node {\textbf{S}} (q_4)
    (q_1) edge  node {b} (q_2)
    (q_2) edge  node {a} (q_3)
    (q_2) edge[bend left, above]  node {S} (q_4)
    (q_2) edge[bend right, above]  node {\textbf{S}} (q_6)
    (q_3) edge  node {b} (q_4)          
    (q_4) edge  node {a} (q_5)
    (q_4) edge[bend left, above]  node {S} (q_6)
    (q_5) edge  node {b} (q_6);
\end{tikzpicture}
\end{center}

Матрица смежности обновлённого графа:

$$
M_2 =
\begin{pmatrix}
[S] & [a] & [S]          & .   & \textbf{[S]} & .   &              \\
.   & [S] & [b]          & .   & .            & .   & .            \\
.   & .   & [S]          & [a] & [S]          & .   & \textbf{[S]} \\
.   & .   & .            & [S] & [b]          & .   & .            \\
.   & .   & .            & .   & [S]          & [a] & [S]          \\
.   & .   & .            & .   & .            & [S] & [b]          \\
.   & .   & .            & .   & .            & .   & [S] 
\end{pmatrix}
$$

И, наконец, последняя содержательная итерация.

\begingroup
\setlength\arraycolsep{2pt}
\begin{align}
&M_3 = M_1^1 \otimes M_2 = 
\begin{pmatrix}
. & [a] & .   & .   & .  \\
. & .   & [S] & .   & .  \\
. & .   & .   & [b] & .  \\
. & .   & .   & .   & [S] \\
. & .   & .   & .   & .
\end{pmatrix}
\otimes 
\begin{pmatrix}
[S] & [a] & [S] & .   & [S] & .   & .   \\
.   & [S] & [b] & .   & .   & .   & .   \\
.   & .   & [S] & [a] & [S] & .   & [S] \\
.   & .   & .   & [S] & [b] & .   & .   \\
.   & .   & .   & .   & [S] & [a] & [S] \\
.   & .   & .   & .   & .   & [S] & [b] \\
.   & .   & .   & .   & .   & .   & [S] 
\end{pmatrix}
=\notag\\
&=
\left(\begin{array}{c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c} 
. & . & . & . & . & . & .  &  . & [a] & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & [a] & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & [a] & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & .   & . & .   & . & .   & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & .   & [S] & .   & \textbf{[S]} & .   & .             &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & [S] & .   & .   & .            & .   & .             &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & [S] & .   & [S]          & .   & \textbf{[S]}  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & [S] & .            & .   & .             &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & [S]          & .   & [S]           &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & .            & [S] & .             &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & .            & .   & [S]           &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [b] & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & [b] & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & [b]  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & .   & [S] & .   & \textbf{[S]} & .   & .             \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & [S] & .   & .   & .            & .   & .             \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & [S] & .   & [S]          & .   & \textbf{[S]}  \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & [S] & .            & .   & .             \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & [S]          & .   & [S]           \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & .            & [S] & .             \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & .            & .   & [S]           \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   
\end{array}\right)
\end{align}
\endgroup

Транзитивное замыкание:
\begingroup
\setlength\arraycolsep{1pt}
\begin{align}
&tc(M_3)=\notag\\
&=
\left(\begin{array}{c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c | c c c c c c c} 
. & . & . & . & . & . & .   &   . & [a] & . & .   & . & .   & .   &   . & \tntm{[aS]} & . & \tntm{[aS]} & . & \tinybf{aS} & .  &  . & . & \tntm{[aSb]} & . & \tntm{[aSb]} & . & \tinybf{aSb}  &  . & . & \tntm{[aSbS]} & . & \tntm{[aSbS]} & . & \tinybf{aSbS}   \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .               \\
. & . & . & . & . & . & .   &   . & .   & . & [a] & . & .   & .   &   . & .           & . & \tntm{[aS]} & . & \tntm{[aS]} & .  &  . & . & .            & . & \tntm{[aSb]} & . & \tntm{[aSb]}  &  . & . & .             & . & \tntm{[aSbS]} & . & \tntm{[aSbS]}   \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .               \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & [a] & .   &   . & .           & . & .           & . & \tntm{[aS]} & .  &  . & . & .            & . & .            & . & \tntm{[aSb]}  &  . & . & .             & . & .             & . & \tntm{[aSbS]}   \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .               \\
. & . & . & . & . & . & .   &   . & .   & . & .   & . & .   & .   &   . & .           & . & .           & . & .           & .  &  . & . & .            & . & .            & . & .             &  . & . & .             & . & .             & . & .               \\
\hline                                                                                
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   [S] & .   & [S] & .   & [S] & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & [S] & .   & .   & .   & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & [S] & .   & [S] & .   & [S]  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & [S] & .   & .   & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & .   & [S] & .   & [S]  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & .   & .   & [S] & .    &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .   &   . & . & . & . & . & . & .   &   .   & .   & .   & .   & .   & .   & [S]  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
\hline                                                                                
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & [b] & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & [b] & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & [b]  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & .   & . & .   & . & .    &  . & . & . & . & . & . & .   \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  [S] & .   & [S] & .   & [S] & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & [S] & .   & .   & .   & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & [S] & .   & [S] & .   & [S] \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & [S] & .   & .   & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & [S] & .   & [S] \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & .   & [S] & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  .   & .   & .   & .   & .   & .   & [S] \\
\hline
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   \\
. & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .  &  . & . & . & . & . & . & .   
\end{array}\right)
\end{align}
\endgroup


В конечном итоге мы получаем такой же результат, как и при первом запуске.
Однако нам потребовалось выполнить существенно больше итераций внешнего цикла, а именно четыре (три содержательных и одна проверочная).
При этом, в ходе работы нам пришлось оперировать существенно б\'{о}льшими матрицами: $35 \times 35$ против $21 \times 21$.

Таким образом --- минимизация рекурсивного автомата как конечного автомата над смешанным алфавитом может быть полезна.
\end{example}

\subsection{Замечания о реализации}
Блочная структура матриц даёт хорошую основу для распределённого умножения при построении транзитивного замыкания.

Матрицу можно представить в виде блочно-разреженной. 
Так как в наших матрицах куча ячеек, для которых можно даже не выделять память, потому что мы знаем, глядя на них, что они пустые.
Аналогично и для части блоков можно заведомо не хранить информацию. %Кодирование данных в ячейках.

Транзитивное замыкание.

\subsection{Вопросы и задачи}

\begin{enumerate}
    \item Оценить пространсвенную сложность алгоритма.
    \item Оценить временную сложность алгоритма.
    \item Найти библиотеку для тензорного произведения. Реализовать алгоритм. Можно предпологать, что запросы содержат ограниченное число терминалов и нетерминалов. Провести замеры. Сравнить с матричным.
    \item Реализовать распределённое решение.
См. блочную структуру
\end{enumerate}